---
title: d3-internmap
date: 2022-06-08 12:02:34
permalink: /pages/KEOSWR/
categories:
  - 前端
  - 源码系列
  - d3源码解析
tags:
  - d3
  - 源码
author:
  name: WJYGRIT
  link: https://github.com/GRITWJY
---

# d3-internmap

这个是在JS的Map上进行改进的


如果你使用 日期(date) 作为JS map(set)的key

```javascript
dateMap = new Map([
    [new Date(Date.UTC(2001,0,1)),'red'],
    [new Date(Date.UTC(2001,0,1)),'green'], // 不同的key值 !
])


dateMap.get(new Date(Date.UTC(2001,0,1))) // undefined !
```

这是因为Map使用了 [零值相等Same-value-zero](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness#same-value-zero_equality)

## internmap使用

```javascript
map = new InternMap([
  [new Date(Date.UTC(2001, 0, 1)), "red"],
  [new Date(Date.UTC(2001, 0, 1)), "green"] // replaces previous entry
])

map.get(new Date(Date.UTC(2001, 0, 1))) // green
    
console.log([...map.keys()]) // [2001-01-01]
map.get(978307200000) // this works too!


map3 = new InternMap([
    [["foo", "bar"], 1],
    [["foo", "baz"], 2],
    [["goo", "bee"], 3]
], JSON.stringify)

map3.get(["foo", "baz"]) // 2
```

InternMap继承自Map，所以只要您喜欢这种行为而不是SameValueZero算法，就可以将其放入。因为InternMap调用对象的值仅对于非原始键，请注意，您也可以传递原始值

## 以下是全部的实现
```javascript
class InternMap extends Map {
  constructor(entries, key = keyof) {
    super();
    Object.defineProperties(this, {_intern: {value: new Map()}, _key: {value: key}});
    if (entries != null) for (const [key, value] of entries) this.set(key, value);
  }
  get(key) {
    return super.get(intern_get(this, key));
  }
  has(key) {
    return super.has(intern_get(this, key));
  }
  set(key, value) {
    return super.set(intern_set(this, key), value);
  }
  delete(key) {
    return super.delete(intern_delete(this, key));
  }
}


class InternSet extends Set {
    constructor(values, key = keyof) {
        super();
        Object.defineProperties(this, {_intern: {value: new Map()}, _key: {value: key}});
        if (values != null) for (const value of values) this.add(value);
    }
    has(value) {
        return super.has(intern_get(this, value));
    }
    add(value) {
        return super.add(intern_set(this, value));
    }
    delete(value) {
        return super.delete(intern_delete(this, value));
    }
}

function intern_get({_intern, _key}, value) {
    const key = _key(value);
    return _intern.has(key) ? _intern.get(key) : value;
}

function intern_set({_intern, _key}, value) {
    const key = _key(value);
    if (_intern.has(key)) return _intern.get(key);
    _intern.set(key, value);
    return value;
}

function intern_delete({_intern, _key}, value) {
    const key = _key(value);
    if (_intern.has(key)) {
        value = _intern.get(key);
        _intern.delete(key);
    }
    return value;
}

function keyof(value) {
    return value !== null && typeof value === "object" ? value.valueOf() : value;
}
```
